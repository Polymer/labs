/*
 * Copyright 2012 The Toolkitchen Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
function PointerEvent(e,t){var n=document.createEvent("MouseEvent");return n.__proto__=PointerEvent.prototype,n.initPointerEvent(e,t),n}PointerEvent.prototype.__proto__=MouseEvent.prototype,PointerEvent.prototype.initPointerEvent=function(e,t){var n={bubbles:!1,cancelable:!1,view:null,detail:null,screenX:0,screenY:0,clientX:0,clientY:0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,button:-1,buttons:null,which:0,relatedTarget:null,pointerId:-1,width:0,height:0,pressure:0,tiltX:0,tiltY:0,pointerType:"unavailable",hwTimestamp:0,isPrimary:!1};for(var r in t)r in n&&(n[r]=t[r]);var i;n.buttons!==null?i=n.buttons?n.button:-1:i=n.which?n.button:-1,Object.defineProperties(this,{pointerId:{value:n.pointerId,enumerable:!0},width:{value:n.width,enumerable:!0},height:{value:n.height,enumerable:!0},pressure:{value:n.pressure,enumerable:!0},tiltX:{value:n.tiltX,enumerable:!0},tiltY:{value:n.tiltY,enumerable:!0},pointerType:{value:n.pointerType,enumerable:!0},hwTimestamp:{value:n.hwTimestamp,enumerable:!0},isPrimary:{value:n.isPrimary,enumerable:!0}}),this.initMouseEvent(e,n.bubbles,n.cancelable,n.view,n.detail,n.screenX,n.screenY,n.clientX,n.clientY,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,i,n.relatedTarget)};var SideTable;typeof WeakMap!="undefined"?SideTable=WeakMap:(SideTable=function(e){this.name="__$"+e+"$__"},SideTable.prototype={set:function(e,t){Object.defineProperty(e,this.name,{value:t,writable:!0})},get:function(e){return e[this.name]}}),function(e){e=e||{},Function.prototype.bind||(Function.prototype.bind=function(t){var n=e.toArray(arguments,1),r=this;return function(){var i=e.toArray(arguments,0);return r.apply(t,n.concat(i))}}),e.toArray=function(e,t){return Array.prototype.slice.call(e,t||0)},window.__PointerEventShim__=e}(window.__PointerEventShim__),function(e){var t={pointers:[],addPointer:function(e){var t={id:e};return this.pointers.push(t),t},removePointer:function(e){var t=this.getPointerIndex(e);if(t>-1)return this.pointers.splice(t,1)[0]},getPointerById:function(e){return this.pointers[this.getPointerIndex(e)]},getPointerIndex:function(e){for(var t=0,n=this.pointers.length,r;t<n&&(r=this.pointers[t]);t++)if(r.id===e)return t;return-1}};e.pointermap=t}(window.__PointerEventShim__),function(e){var t={targets:new SideTable("target"),handledEvents:new SideTable("pointer"),events:[],eventMap:{},eventSources:{},registerSource:function(e,t){var n=t;this.events=n.events,this.events.forEach(function(e){n[e]&&(this.eventMap[e]=n[e].bind(n))},this),this.eventSources[e]=n},registerTarget:function(e){this.listen(this.events,e)},unregisterTarget:function(e){this.unlisten(this.events,e)},down:function(e){this.fireEvent("pointerdown",e)},move:function(e){this.fireEvent("pointermove",e)},up:function(e){this.fireEvent("pointerup",e)},enter:function(e){this.fireEvent("pointerenter",e)},leave:function(e){this.fireEvent("pointerleave",e)},over:function(e){this.fireEvent("pointerover",e)},out:function(e){this.fireEvent("pointerout",e)},cancel:function(e){this.fireEvent("pointercancel",e)},eventHandler:function(e){if(this.handledEvents.get(e))return;var t=e.type,n=this.eventMap&&this.eventMap[t];n&&n(e),this.handledEvents.set(e,!0)},listen:function(e,t){e.forEach(function(e){this.addEvent(e,this.boundHandler,!1,t)},this)},unlisten:function(e){e.forEach(function(e){this.removeEvent(e,this.boundHandler,!1,inTarget)},this)},addEvent:function(e,t,n,r){r.addEventListener(e,t,n)},removeEvent:function(e,t,n,r){r.removeEventListener(e,t,n)},makeEvent:function(e,t){var n=new PointerEvent(e,t);return this.targets.set(n,this.targets.get(t)||t.target),n},fireEvent:function(e,t){var n=this.makeEvent(e,t);return this.dispatchEvent(n)},cloneEvent:function(e){var t={};for(var n in e)t[n]=e[n];return t},getTarget:function(e){return this.captureInfo&&this.captureInfo.id===e.pointerId?this.captureInfo.target:this.targets.get(e)},dispatchEvent:function(e){var t=this.getTarget(e);if(t)return t.dispatchEvent(e)}};t.boundHandler=t.eventHandler.bind(t),e.dispatcher=t,e.register=function(e){t.registerTarget(e)},e.unregister=function(e){t.unregisterTarget(e)}}(window.__PointerEventShim__),function(e){var t=e.dispatcher,n=e.pointermap,r=Array.prototype.map.call.bind(Array.prototype.map),i={events:["touchstart","touchmove","touchend","touchcancel"],POINTER_TYPE:"touch",firstTouch:null,isPrimaryTouch:function(e){return this.firstTouch===e.identifier},removePrimaryTouch:function(e){this.isPrimaryTouch(e)&&(this.firstTouch=null)},touchToPointer:function(e){var n=t.cloneEvent(e);return n.pointerId=e.identifier+2,n.target=this.findTarget(n),n.bubbles=!0,n.cancelable=!0,n.button=0,n.buttons=1,n.isPrimary=this.isPrimaryTouch(e),n.pointerType=this.POINTER_TYPE,n},processTouches:function(e,t){var n=e.changedTouches,i=r(n,this.touchToPointer,this);i.forEach(t,this)},findTarget:function(e){return document.elementFromPoint(e.clientX,e.clientY)},touchstart:function(e){this.firstTouch===null&&(this.firstTouch=e.changedTouches[0].identifier),this.processTouches(e,this.overDown)},overDown:function(e){var r=n.addPointer(e.pointerId);t.over(e),t.down(e),r.out=e},touchmove:function(e){e.preventDefault(),this.processTouches(e,this.moveOverOut)},moveOverOut:function(e){var r=e,i=n.getPointerById(r.pointerId),s=i.out;t.move(r),s&&s.target!==r.target&&(s.relatedTarget=r.target,r.relatedTarget=s.target,t.out(s),t.over(r)),i.out=r},touchend:function(e){this.processTouches(e,this.upOut)},upOut:function(e){t.up(e),t.out(e),n.removePointer(e.pointerId),this.removePrimaryTouch(e)},touchcancel:function(e){this.processTouches(e,this.cancelOut)},cancelOut:function(e){t.cancel(e),t.out(e),n.removePointer(e.pointerId),this.removePrimaryTouch(e)}},s={POINTER_ID:1,POINTER_TYPE:"mouse",events:["mousedown","mousemove","mouseup","mouseover","mouseout"],prepareEvent:function(e){var n=t.cloneEvent(e);return n.pointerId=this.POINTER_ID,n.isPrimary=!0,n.pointerType=this.POINTER_TYPE,n},mousedown:function(e){if(n.getPointerIndex(this.POINTER_ID)==-1){var r=this.prepareEvent(e),i=n.addPointer(this.POINTER_ID);i.button=e.button,t.down(r)}},mousemove:function(e){var n=this.prepareEvent(e);t.move(n)},mouseup:function(e){var r=n.getPointerById(this.POINTER_ID);if(r&&r.button===e.button){var i=this.prepareEvent(e);t.up(i),n.removePointer(this.POINTER_ID)}},mouseover:function(e){var n=this.prepareEvent(e);t.over(n)},mouseout:function(e){var n=this.prepareEvent(e);t.out(n)}};window.navigator.pointerEnabled===undefined&&("ontouchstart"in window?t.registerSource("touch",i):t.registerSource("mouse",s),t.registerTarget(document),Object.defineProperty(window.navigator,"pointerEnabled",{value:!0,enumerable:!0}))}(window.__PointerEventShim__),function(e){e=e||{},Function.prototype.bind||(Function.prototype.bind=function(t){var n=e.toArray(arguments,1),r=this;return function(){var i=e.toArray(arguments,0);return r.apply(t,n.concat(i))}}),e.toArray=function(e,t){return Array.prototype.slice.call(e,t||0)},window.__PointerGestureShim__=e}(window.__PointerGestureShim__),function(e){var t={handledEvents:new SideTable("gesture"),targets:new SideTable("target"),pointers:new SideTable("pointers"),handlerQueue:{},events:["pointerdown","pointermove","pointerup","pointerover","pointerout"],registerRecognizer:function(e){var t=e;this.events.forEach(function(e){if(t[e]){var n=t[e].bind(t);this.addHandler(e,n)}},this)},addHandler:function(e,t){var n=e;this.handlerQueue[n]||(this.handlerQueue[n]=[]),this.handlerQueue[n].push(t)},registerTarget:function(e){this.listen(this.events,e)},unregisterTarget:function(e){this.unlisten(this.events,e)},eventHandler:function(e){if(this.handledEvents.get(e))return;var t=e.type,n;(n=this.handlerQueue[t])&&this.runQueue(n,e),this.handledEvents.set(e,!0)},runQueue:function(e,t){for(var n=0,r,i=e.length;n<i&&(r=e[n]);n++)if(r(t)===!0)break},listen:function(e,t){e.forEach(function(e){this.addEvent(e,this.boundHandler,!1,t)},this)},unlisten:function(e){e.forEach(function(e){this.removeEvent(e,this.boundHandler,!1,inTarget)},this)},addEvent:function(e,t,n,r){r.addEventListener(e,t,n)},removeEvent:function(e,t,n,r){r.removeEventListener(e,t,n)},makeEvent:function(e,t){var n;e.buttons!==undefined?n=e.buttons?e.button:-1:n=e.which?e.button:-1;var r=document.createEvent("MouseEvent");return r.initMouseEvent(t,e.bubbles,e.cancelable,e.view,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,n,e.relatedTarget),this.targets.set(r,this.targets.get(e)||e.target),this.pointers.set(r,[e]),r},setProperties:function(e,t){var n={};for(var r in t)n[r]={value:t[r],enumerable:!0};Object.defineProperties(e,n)},setPointers:function(e,t){var n=t.slice(0);Object.freeze(n),this.setProperties(e,{pointers:n})},cloneEvent:function(e){var t={};for(var n in e)t[n]=e[n];return t},dispatchEvent:function(e,t){var n=t||this.targets.get(e);if(n)return e.pointers||this.setPointers(e,this.pointers.get(e)),n.dispatchEvent(e)}};t.boundHandler=t.eventHandler.bind(t),e.dispatcher=t,e.register=function(e){t.registerTarget(e)},e.unregister=function(e){t.unregisterTarget(e)},t.registerTarget(document)}(window.__PointerGestureShim__),function(e){var t=e.dispatcher,n={HOLD_DELAY:200,WIGGLE_THRESHOLD:16,events:["pointerdown","pointermove","pointerup"],heldPointer:null,holdJob:null,pulse:function(){var e=Date.now()-this.heldPointer.timeStamp,t=this.held?"tkholdpulse":"tkhold";this.makeHold(t,{holdTime:e}),this.held=!0},cancel:function(){clearInterval(this.holdJob),this.makeHold("tkrelease"),this.held=!1,this.heldPointer=null,this.holdJob=null},pointerdown:function(e){e.isPrimary&&(this.heldPointer=e,this.holdJob=setInterval(this.pulse.bind(this),this.HOLD_DELAY))},pointerup:function(e){this.heldPointer&&e.isPrimary&&this.cancel()},pointermove:function(e){if(this.heldPointer&&e.isPrimary){var t=e.clientX-this.heldPointer.clientX,n=e.clientY-this.heldPointer.clientY;t*t+n*n>this.WIGGLE_THRESHOLD&&this.cancel()}},makeHold:function(e,n){var r=t.makeEvent(this.heldPointer,e);n&&t.setProperties(r,n),t.dispatchEvent(r)}};t.registerRecognizer(n)}(window.__PointerGestureShim__),function(e){var t=e.dispatcher,n={MIN_VELOCITY:.5,events:["pointerdown","pointerup"],flickStart:null,pointerdown:function(e){e.isPrimary&&(this.flickStart=e)},pointerup:function(e){e.isPrimary&&this.flickStart&&(this.makeFlick(this.flickStart,e),this.flickStart=null)},makeFlick:function(e,n){var r=e,i=n,s=i.timeStamp-r.timeStamp,o=i.clientX-r.clientX,u=i.clientY-r.clientY,a=o/s,f=u/s,l=Math.sqrt(a*a+f*f),c=Math.abs(a)>Math.abs(f)?"x":"y",h=this.calcAngle(a,f);if(Math.abs(l)>=this.MIN_VELOCITY){var p=t.makeEvent(i,"tkflick");t.setProperties(p,{xVelocity:a,yVelocity:f,velocity:l,angle:h,majorAxis:c}),t.dispatchEvent(p,r.target)}},calcAngle:function(e,t){return Math.atan2(t,e)*180/Math.PI}};t.registerRecognizer(n)}(window.__PointerGestureShim__),function(e){var t=e.dispatcher,n={events:["pointerdown","pointermove","pointerup"],trackStart:null,lastTrack:null,makeTrack:function(e,n){var r=e.clientX-this.trackStart.clientX,i=e.clientY-this.trackStart.clientY,s=0,o=0;this.lastTrack&&(s=e.clientX-this.lastTrack.clientX,o=e.clientY-this.lastTrack.clientY);var u=t.makeEvent(e,n);t.setProperties(u,{dx:r,dy:i,ddx:s,ddy:o}),t.dispatchEvent(u,this.trackStart.target)},pointerdown:function(e){e.isPrimary&&(this.trackStart=e,this.lastTrack=e,this.makeTrack(e,"tktrackstart"))},pointermove:function(e){e.isPrimary&&this.trackStart&&(this.makeTrack(e,"tktrack"),this.lastTrack=e)},pointerup:function(e){e.isPrimary&&(this.makeTrack(e,"tktrackend"),this.lastTrack=null,this.trackStart=null)}};t.registerRecognizer(n)}(window.__PointerGestureShim__);