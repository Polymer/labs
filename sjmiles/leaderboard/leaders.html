<!doctype html>
<html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>Firebase Leaderboard</title>

  <style>
    html, body, body > core-layout {
      height: 100%;
    }

    body {
      background: #fafafa;
      font-family: "Helvetica Neue", Helvetica, sans-serif;
      margin: 0;
      -webkit-user-select: none;
    }

    header {
      -webkit-font-smoothing: antialiased;
      background: #7e57c2;
      color: #fff;
      font-size: 24px;
      font-weight: 400;
      letter-spacing: -.012em;
      line-height: 32px;
      text-rendering: optimizeLegibility;
      padding: 16px;
    }

    .scroll-container {
      overflow-y: auto;
      padding: 8px 0;
      position: relative;
    }

    section {
      position: relative;
    }

    [inviso] {
      opacity: 0.0 !important;
    }

    [abs] {
      left: 0;
      position: absolute;
      top: 8px;
      width: 100%;
    }

    .focused {
      box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.19), 0 8px 17px 0 rgba(0, 0, 0, 0.2);
    }

    .moving::shadow #rank {
      opacity: 0;
    }
  </style>

  <script src="../components/platform/platform.js"></script>

  <link rel="import" href="../components/core-layout/core-layout.html">
  <link rel="import" href="../components/core-localstorage/core-localstorage.html">
  <link rel="import" href="../components/firebase-element/firebase-element.html">

  <script>
    sequence = function(args, times, keyframes) {
      var time = times.shift() || 500;
      var key = keyframes.shift();
      if (key) {
        key.apply(this, args.concat([time]));
        setTimeout(function() {
          sequence(args, times, keyframes);
        }, time + 10);
      }
    };
  </script>

  <polymer-element name="x-leaderboard-item">

    <template>

      <link href="x-leaderboard-item.css" rel="stylesheet">

      <firebase-element
        id="playerData"
        location="{{firebaseRoot}}/{{name}}"
        data="{{player}}"
        on-data-change="{{onDataChange}}">
      </firebase-element>

      <core-layout>
        <div id="rank">{{rank}}</div>
        <div id="icon" style="background-image:url('{{player.image}}')"></div>
        <div id="name" flex>{{name}}</div>
        <div id="score">{{player.score}}</div>
      </core-layout>

    </template>

    <script>
      Polymer('x-leaderboard-item', {
        publish: {
          name: {value: '', reflect: true},
          rank: 0,
          firebaseRoot: ''
        },
        previousScore: -1,
        onDataChange: function() {
          var score = Number(this.player.score);
          if (this.previousScore >= 0) {
            var delta = score - this.previousScore;
            if (delta > 0) {
              this.bounceDelta(delta);
            }
          }
          this.previousScore = score;
        },
        bounceDelta: function(delta) {
          // TODO(nevir): Why is it not bouncing on the first iteration?
          sequence([this.$.score], [280, 0], [
            function(score, time) {
              score.style.webkitAnimation = 'bounce ' + time + 'ms ease-in-out';
            },
            function(score) {
              score.style.webkitAnimation = null;
            }
          ]);
        }
      });
    </script>
  </polymer-element>

</head>
<body>

  <core-layout vertical>
    <header>It's a leaderboard!</header>
    <div class="scroll-container" flex>
      <template is="auto-binding">

      <firebase-element id="gameData" on-data-change="{{dataChange}}" data="{{players}}" location="https://polygame.firebaseio.com/players/"></firebase-element>

      <section abs id="a">
        <template repeat="{{name, i in cached}}">
          <x-leaderboard-item on-tap="{{points}}" firebaseRoot="https://polygame.firebaseio.com/players" name="{{name}}" rank="{{i + 1}}"></x-leaderboard-item>
        </template>
      </section>

      <section id="b">
        <template repeat="{{name, i in names}}">
          <x-leaderboard-item on-tap="{{points}}" firebaseRoot="https://polygame.firebaseio.com/players" name="{{name}}" rank="{{i + 1}}"></x-leaderboard-item>
        </template>
      </section>

<!-- For debugging?
      <section>
        <template repeat="{{name in pnames}}">
          <p class="item" on-tap="{{points}}" horizontal center layout><span class="dot" style="background-color: {{players[name].color || 'lightblue'}}"></span>&nbsp;<span>{{name}}: {{players[name].score}}</span></p>
        </template>
      </section>
-->

    </template>
    </div>
  </core-layout>

  <script>

    addEventListener('template-bound', function(e) {

      var scope = e.target;
      var animating = false;

      reset = function() {
        var irand = function(n) { return Math.floor(Math.random() * n); }
        scope.players = {
          'Steve': {score: irand(1e9) + 1e4, color: 'lightblue'},
          'Frankie': {score: irand(100) + 500, color: 'lightgreen'},
          'Daniel': {score: irand(100) + 500, color: 'magenta'},
          'Yvonne': {score: irand(100) + 500, color: 'tomato'},
          'Scott': {score: irand(100), color: 'orange'}
        };
        scope.$.gameData.commit();
      };

      scope.dataChange = function() {
        if (animating) {
          //console.log('jobbing...');
          this.job('dataJob', this.dataChange, 500);
          return;
        }
        //
        //console.log('animating...');
        if (this.names) {
          // will be rendered by next raf
          this.cached = this.names;
          this.async(this.transition);
          animating = true;
        }
        //
        var players = this.players;
        this.names = Object.keys(players);
        this.names.sort(function(n0, n1) {
          var s0 = players[n0].score, s1 = players[n1].score;
          return s1 - s0;
        });
        //
        var indices = this.indices = [];
        this.names.forEach(function(n, i) {
          indices[n] = i;
        });
        //
        this.pnames = Object.keys(this.players);
      };

      scope.transition = function() {

        var items = this.names.map(function(n) {
          var slctr = '[name="' + n + '"]';
          var e0 = a.querySelector(slctr), e1 = b.querySelector(slctr);
          var i = {
            n: n,
            e0: e0,
            t0: e0.getBoundingClientRect().top,
            e1: e1,
            t1: e1.getBoundingClientRect().top
          };
          return i;
        });

        sequence([items], [500, 500, 0], [
          function(items, time) {
            b.setAttribute('inviso', '');
            items.forEach(function(i) {
              if (i.t1 != i.t0) {
                i.dy = i.t1 - i.t0;
                i.e0.classList.add('moving');
                if (i.dy < 0) {
                  i.e0.classList.add('focused');
                }
                i.e0.style.webkitTransform = 'translate(0px, ' + i.dy + 'px)';
                i.e0.style.transition = '-webkit-transform ' + time + 'ms ease-out, box-shadow ' + time + 'ms ease-out';
              }
            });
          },
          function(items) {
            items.forEach(function(i) {
              i.e0.classList.remove('focused');
              if (i.dy) {
                i.e0.style.webkitTransform = 'translate(0px, ' + i.dy + 'px)';
              }
            });
          },
          function(items) {
            b.removeAttribute('inviso');
            items.forEach(function(i) {
              i.e0.classList.remove('moving');
              if (i.dy) {
                i.e0.style.webkitTransform = null;
                i.e0.style.transition = 'none';
              }
            });
          },
          function() {
            animating = false;
          }
        ]);
      };

      scope.points = function(event) {
        var name = event.target.templateInstance.model.name;
        this.players[name].score++;
        //
        /*
        var irand = function(n) { return Math.floor(Math.random() * n); }
        var name = this.names[irand(this.names.length)];
        this.players[name].score++;
        */
        //
        this.$.gameData.commit();
      };

    });
  </script>

</body>
</html>
